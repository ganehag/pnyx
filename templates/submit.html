{% extends "base.html" %}

{% block title %}{% trans %}Create entry{% endtrans %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
{% endblock %}


{% block content %}
<div class="container pt-3">
<div class="row">
  <div class="col-md-8">
    {% if entry %}
    <h5>{% trans %}Edit Post{% endtrans %}</h5>
    {% else %}
    <h5>{% trans %}Create a Post{% endtrans %}</h5>
    {% endif %}

    {% if community %}
    <form id="autocomplete" action="#" class="form-horizontal" method="post" data-id="{{ community.id }}">
    {% else %}
    <form id="autocomplete" action="#" class="form-horizontal" method="post">
    {% endif %}

    <div class="form-group" style="position: relative;">
        <select class="form-control" id="community-query" name="community-query" placeholder="Select a Community..." {% if entry and entry.slug %}disabled{% endif %}>
          {% if community %}
            <option value="{{ community.name_with_prefix }}" selected="selected">{{ community.name_with_prefix }}</option>
          {% endif %}
        </select>
    </div>
    </form>

    {% if entry and entry.slug %}
    <form id="new_post" action="{{ url_for('post_edit', slug=entry.slug) }}" class="form-horizontal" method="post" data-id="{{ community.id }}">
    {% elif community %}
    <form id="new_post" action="{{ url_for('submit', community=community.name) }}" class="form-horizontal" method="post" data-id="{{ community.id }}">
    {% else %}
    <form id="new_post" action="{{ url_for('submit') }}" class="form-horizontal" method="post">
    {% endif %}

    {% with errors = get_flashed_messages(category_filter=["error"]) %}
     {% if errors %}
      {%- for msg in errors %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      {% endfor -%}
    {% endif %}
    {% endwith %}


    <div class="card mb-3">
      <div class="card-body">
          <input type="hidden" id="community" name="community" value="{{ community.name }}">
          {% if entry and entry.slug %}
          <input type="hidden" name="title" value="{{ entry.title }}">
          {% endif %}

          <div class="form-group">
            <input class="form-control" {% if not (entry and entry.slug) %}id="title" name="title"{% endif %} type="text" value="{{ entry.title }}" placeholder="Title" {% if entry and entry.slug %}disabled{% endif %}>
          </div>

          <div class="form-group">
            <textarea class="form-control" id="content" name="content" style="height: 300px;" placeholder="Text (optional)">{{ entry.content }}</textarea>
          </div>

          <div class="form-group">
            <button class="btn btn-primary" type="submit">{% block save_button %}{% trans %}Publish{% endtrans %}{% endblock %}</button>
          </div>

      </div>
    </div>
    </form>
  </div>

  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header">
        <h6 class="card-title mb-0">Pnyx Rules</h6>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item">1. Remember the human</li>
        <li class="list-group-item">2. Behave like you would in real life</li>
        <li class="list-group-item">3. Look for the original source of content</li>
        <li class="list-group-item">4. Search for duplicates before posting</li>
        <li class="list-group-item">5. Read the communityâ€™s rules</li>
      </ul>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block js %}
$(document).ready(function() {
  var easyMDE = new EasyMDE({element: $('#content')[0]});

  {% if not (entry and entry.slug) %}

  $('#community-query').select2({
    ajax: {
      url: "{{ url_for('community_search') }}",
      dataType: 'json',
      delay: 250,
      data: function (params) {
        var query = {
          q: params.term,
          s: 1,
        }
        return query;
      },
      processResults: function (data) {
        return {
          results: data.results
        };
      }
    }
  }).on('select2:select', function (e) {
    var data = e.params.data;
    $('#community').val(data.id);
  });

  {% endif %}

});
{% endblock %}